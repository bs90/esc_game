<%# Custom view for has_many field to add "Create new" button %>
<div class="field-unit field-unit--has-many">
  <div class="field-unit__field">
    <% if field.data.any? %>
      <%# Get dashboard class to access collection attributes %>
      <% first_resource = field.data.first %>
      <% dashboard_class_name = "#{first_resource.class.name}Dashboard" %>
      <% dashboard = dashboard_class_name.constantize.new %>

      <table class="table" style="table-layout: fixed; width: 100%;">
        <thead>
          <tr>
            <% dashboard.class::COLLECTION_ATTRIBUTES.each do |attr_name| %>
              <th style="max-width: 200px; word-wrap: break-word; overflow-wrap: break-word;"><%= attr_name.to_s.humanize %></th>
            <% end %>
            <th style="width: 100px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% field.data.limit(10).each do |resource| %>
            <tr>
              <% dashboard.class::COLLECTION_ATTRIBUTES.each_with_index do |attr_name, index| %>
                <td style="max-width: 200px; word-wrap: break-word; overflow-wrap: break-word; white-space: normal;">
                  <% if index == 0 %>
                    <%# First column (usually name) - make it a link %>
                    <% resource_path = "/admin/#{resource.class.name.underscore.pluralize}/#{resource.id}" %>
                    <%= link_to(
                      resource.send(attr_name).to_s,
                      resource_path,
                      class: "action-show"
                    ) %>
                  <% else %>
                    <%= resource.send(attr_name).to_s %>
                  <% end %>
                </td>
              <% end %>
              <td style="width: 100px; white-space: nowrap;">
                <% edit_resource_path = "/admin/#{resource.class.name.underscore.pluralize}/#{resource.id}/edit" %>
                <%= link_to(
                  "Edit",
                  edit_resource_path,
                  class: "button"
                ) %>
                <%# Add Sell button for items %>
                <% if field.attribute.to_s == "items" && resource.class.name == "Item" %>
                  <button
                    class="button button--secondary sell-item-btn"
                    style="margin-left: 5px;"
                    data-item-id="<%= resource.id %>"
                    data-item-name="<%= resource.name %>"
                    data-item-points="<%= resource.points || 0 %>"
                  >
                    Sell
                  </button>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
      <% if field.data.count > 10 %>
        <p><em>... and <%= field.data.count - 10 %> more</em></p>
      <% end %>
    <% end %>

    <%# Add "Create new item" button for items field %>
    <% if field.attribute.to_s == "items" && field.resource.respond_to?(:id) %>
      <div style="margin-top: 15px;">
        <%= link_to(
          "Create new hints",
          "/admin/items/new?room_id=#{field.resource.id}",
          class: "button button--primary"
        ) %>
      </div>
    <% end %>
  </div>
</div>

<%# Sell Item Modal - only show for items field %>
<% if field.attribute.to_s == "items" %>
  <div id="sellItemModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div class="modal-content" style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 500px; border-radius: 8px;">
      <span class="close" onclick="closeSellModal()" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
      <h2 style="margin-top: 0;">Sell Hints</h2>
      <%= form_with url: "/admin/items/sell", method: :post, local: true, id: "sellItemForm" do |f| %>
        <%= f.hidden_field :item_id, id: "sell_item_id" %>

        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">Hint Name:</label>
          <p id="sell_item_name" style="padding: 8px; background-color: #f5f5f5; border-radius: 4px; margin: 0;"></p>
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">Points:</label>
          <p id="sell_item_points" style="padding: 8px; background-color: #f5f5f5; border-radius: 4px; margin: 0;"></p>
        </div>

        <div style="margin-bottom: 15px;">
          <%= f.label :team_id, "Select Team:", style: "display: block; margin-bottom: 5px; font-weight: bold;" %>
          <%= f.select :team_id,
              options_from_collection_for_select(Team.all, :id, :name),
              { prompt: "Choose a team..." },
              { id: "sell_team_id", required: true, style: "width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" } %>
        </div>

        <div style="margin-top: 20px; text-align: right;">
          <button type="button" onclick="closeSellModal()" class="button" style="margin-right: 10px;">Cancel</button>
          <%= f.submit "Sell", class: "button button--primary" %>
        </div>
      <% end %>
    </div>
  </div>

  <script>
    function openSellModal(itemId, itemName, itemPoints) {
      var modal = document.getElementById('sellItemModal');
      if (!modal) {
        console.error('Sell modal not found');
        return;
      }
      var itemIdField = document.getElementById('sell_item_id');
      var itemNameField = document.getElementById('sell_item_name');
      var itemPointsField = document.getElementById('sell_item_points');

      if (itemIdField) itemIdField.value = itemId;
      if (itemNameField) itemNameField.textContent = itemName;
      if (itemPointsField) itemPointsField.textContent = itemPoints;
      modal.style.display = 'block';
    }

    function closeSellModal() {
      var modal = document.getElementById('sellItemModal');
      if (modal) {
        modal.style.display = 'none';
        var form = document.getElementById('sellItemForm');
        if (form) {
          form.reset();
        }
      }
    }

    // Initialize event listeners
    function initSellModal() {
      // Handle sell button clicks using event delegation
      document.addEventListener('click', function(event) {
        if (event.target && event.target.classList.contains('sell-item-btn')) {
          var button = event.target;
          var itemId = button.getAttribute('data-item-id');
          var itemName = button.getAttribute('data-item-name');
          var itemPoints = button.getAttribute('data-item-points');
          openSellModal(itemId, itemName, itemPoints);
        }
      });

      // Handle close button
      var closeBtn = document.querySelector('#sellItemModal .close');
      if (closeBtn) {
        closeBtn.addEventListener('click', closeSellModal);
      }

      // Close modal when clicking outside of it
      var modal = document.getElementById('sellItemModal');
      if (modal) {
        modal.addEventListener('click', function(event) {
          if (event.target == modal) {
            closeSellModal();
          }
        });
      }
    }

    // Run initialization
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSellModal);
    } else {
      initSellModal();
    }
  </script>
<% end %>

